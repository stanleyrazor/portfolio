<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Stanley Sayianka">
<meta name="dcterms.date" content="2024-08-16">

<title>Stanley Sayianka - Hierarchical Generalized Additive Models using INLA</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Stanley Sayianka</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html" rel="" target="">
 <span class="menu-text">Projects</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Hierarchical Generalized Additive Models using INLA</h1>
            <p class="subtitle lead">HGAMs in INLA</p>
                                <div class="quarto-categories">
                <div class="quarto-category">code</div>
                <div class="quarto-category">stats</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Stanley Sayianka </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 16, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">
<script defer="" src="https://cloud.umami.is/script.js" data-website-id="e2626c70-2118-4fa1-bf3c-49552f9b4ccf"></script>




<p>Image copyrights: https://m-clark.github.io/generalized-additive-models/introduction.html</p>
<section id="gams-and-hgams" class="level1 page-columns page-full">
<h1>GAMs and HGAMs</h1>
<p>Generalized Additive Models (GAMs) are a powerful extension of Generalized Linear Models (GLMs), as they offer the flexibility to incorporate non-linear effects of covariates using smooth functions within the GLM framework.</p>
<p>The model formulation for a GAM can be expressed as: <span class="math display">\[E(y_i) = \mu_i\]</span> <span class="math display">\[g(\mu_i) = \eta_i = \sum_{k=0}^{p_l} \beta_kz_{ik} + \sum_{j=1}^{p_s} s_j(x_{ij})\]</span></p>

<div class="no-row-height column-margin column-container"><div class="">
<p>The intercept has been absorbed into the linear predictor, and takes the coefficient for <span class="math inline">\(beta_0\)</span></p>
<p><span class="math inline">\(y_i\)</span> is the response variable</p>
<p><span class="math inline">\(\mu\)</span> is the mean of the response</p>
<p><span class="math inline">\(g(\cdot)\)</span> is the link function</p>
<p><span class="math inline">\(\eta_i\)</span> is the linear predictor, which in this case is a structural additive predictor.</p>
<p><span class="math inline">\(\beta_i\)</span> are the regression coefficients for the linear terms</p>
<p><span class="math inline">\(s_j(\cdot)\)</span> are smooth functions of the covariates <span class="math inline">\(x_j\)</span></p>
<p><span class="math inline">\(p_l\)</span> is the number of covariates modelled using the linear functions, and <span class="math inline">\(p_s\)</span> is the number of covariates modelled using the smooth functions.</p>
</div></div><p>The primary distinction between GLMs and GAMs lies in the latter’s ability to incorporate covariates into the model using smooth functions, which are often non-linear. This extension proves particularly valuable when dealing with covariates that exhibit non-linear relationships with the response variable.</p>
<div class="page-columns page-full"><p>In the traditional GLM framework, analysts typically attempt to account for non-linearity using power functions, trigonometric functions, polynomials, or predefined splines<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. However, these approaches may often fall short in capturing complex relationships. GAMs address this limitation by utilizing a wide range of flexible smooth functions based on various basis expansions<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;think the <code>splines::ns</code> or <code>splines::bs</code> in R</p></li><li id="fn2"><p><sup>2</sup>&nbsp;See the <code>?mgcv::s</code> or <code>smooth.terms{mgcv}</code></p></li></div></div>
<p>The adaptability of GAMs allows for more accurate modeling of complex, non-linear relationships between predictors and the response variable, potentially leading to improved model fit and predictive performance compared to their linear counterparts. An often helpful use case of GAMs are in incorporating spatial effects into models.</p>
<p>A natural extension to the standard GAM, is to build GAM models, where the smooth relationships between covariates and the response are allowed to vary differently by groups in the data. This is what gives rise to the hierarchical GAMs.</p>
</section>
<section id="inla" class="level1 page-columns page-full">
<h1>INLA</h1>
<p>The Integrated Nested Laplace Approximation (INLA) is an approximate method for Bayesian inference that offers a fast and efficient alternative to traditional Markov Chain Monte Carlo (MCMC) techniques. INLA aims to provide fast and accurate approximations of posterior distributions for a wide class of latent Gaussian models.</p>
<div class="page-columns page-full"><p>Briefly, for a response variable <span class="math inline">\(y_i\)</span> belonging to the exponential family, where its mean <span class="math inline">\(\mu_i\)</span> is linked to a structural additive predictor <span class="math inline">\(\eta_i\)</span> of the form<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>:</p><div class="no-row-height column-margin column-container"><li id="fn3"><p><sup>3</sup>&nbsp;Again, the intercept has been absorbed into the summation of the linear predictor</p></li></div></div>
<p><span class="math display">\[\eta_i = \sum_{k=0}^{n_\beta}\beta_kz_{ki} + \sum_{j=1}^{n_f}f^{(j)}(u_{ji}) + \epsilon_i\]</span></p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Here:</p>
<p><span class="math inline">\(f^{(j)}(\cdot)\)</span> are unknown functions of certain covariates</p>
<p><span class="math inline">\(\beta_k\)</span> represent the linear effects of certain covariates</p>
<p><span class="math inline">\(\epsilon_i\)</span> are the unstructured error terms</p>
</div></div><p>Latent gaussian models are a subset of all bayesian models with the structural additive predictor as the one above, where a gaussian prior is assigned to <span class="math inline">\(\ f^{(j)}(\cdot), \ \beta_k, \ and \  \epsilon_i\)</span>.</p>
<p>This approach is particularly well-suited for linear, generalized linear and generalized additive models, even those with spatial, temporal, as well as hierarchical structures. This makes INLA an excellent choice for implementing Hierarchical Generalized Additive Models (HGAMs). INLA’s computational efficiency allows for the analysis of complex models and large datasets that might be computationally prohibitive with MCMC methods.</p>
<div class="page-columns page-full"><p>The <code>{R-INLA}</code> package brings this methodology to R. For those interested in a comprehensive yet accessible introduction to INLA and its implementation in R, Virgilio Gómez-Rubio (2020)<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> and Wang et al.&nbsp;(2018)<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> serve as excellent resources.</p><div class="no-row-height column-margin column-container"><li id="fn4"><p><sup>4</sup>&nbsp;Gómez-Rubio, Virgilio (2020). Bayesian Inference with INLA. Chapman &amp; Hall/CRC Press. Boca Raton, FL.</p></li><li id="fn5"><p><sup>5</sup>&nbsp;Wang, X., Yue, Y. R., &amp; Faraway, J. J. (2018). Bayesian regression modeling with INLA. Chapman and Hall/CRC.</p></li></div></div>
<p>In INLA, the shape of <span class="math inline">\(f(\cdot)\)</span> , the smooth terms are commonly represented using the following functions:</p>
<ol type="1">
<li><p><span class="math inline">\(AR(p)\)</span>: Autoregressive models of order p, with p being at most 10.</p></li>
<li><p><span class="math inline">\(RW(u)\)</span>: Random walk terms. In INLA, currently only random walks of order 1 and 2 are implemented.</p></li>
<li><p>For irregularly spaced data, Stochastic Partial Differential Equation (SPDE) are implemented in INLA.</p></li>
</ol>

<div class="no-row-height column-margin column-container"><div class="">
<p>For auto-regressive models:</p>
<p><span class="math display">\[y_t = \alpha + u_t + \varepsilon_t, \quad t = 1, \ldots, n\]</span></p>
<p><span class="math display">\[u_1 \sim N(0, \tau_u(1-\rho^2)^{-1})\]</span></p>
<p><span class="math display">\[u_t = \rho u_{t-1} + \epsilon_t, \quad t = 2, \ldots, n\]</span></p>
<p><span class="math display">\[\varepsilon_t \sim N(0, \tau_\varepsilon), \quad t = 1, \ldots, n\]</span></p>
<p>For random walk models (here order: 1) :</p>
<p><span class="math display">\[y_t = \alpha + u_t + \varepsilon_t, \quad t = 1, \ldots, n\]</span></p>
<p><span class="math display">\[u_t - u_{t-1} \sim N(0, \tau_u), \quad t = 2, \ldots, n\]</span></p>
<p><span class="math display">\[\varepsilon_t \sim N(0, \tau_\varepsilon), \quad t = 1, \ldots, n\]</span></p>
</div></div><div class="page-columns page-full"><p>More information on the derivations and motivations for using the above can be found in Virgilio Gómez-Rubio (2020) Chpt. 9<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</p><div class="no-row-height column-margin column-container"><li id="fn6"><p><sup>6</sup>&nbsp;https://becarioprecario.bitbucket.io/inla-gitbook/ch-smoothing.html</p></li></div></div>
</section>
<section id="models" class="level1 page-columns page-full">
<h1>Models</h1>
<p>In this blog, I will try to replicate the models described in this paper using the INLA methodology:</p>
<p>Pedersen EJ, Miller DL, Simpson GL, Ross N. 2019. Hierarchical generalized additive models in ecology: an introduction with mgcv. PeerJ 7:e6876 DOI 10.7717/peerj.6876</p>
<p>This excellent paper, provides an overview of the connection between hierarchical GLMs and GAMs, their similarities in terms of how they fit highly variable models to data, especially those involving group specific terms (intercepts and slopes), and their applications to ecology.</p>
<p>A key advantage of HGAMs is the ability to provide sensible estimates, in cases where each group in the data does not have sufficient data points (building seperate models for different groups could lead to noisy predictions), the hierarchical component also allows us to build models that are able to give better predictions in different groups, as well as overall-y on average (building models while ignoring any hierarchy/grouping present in the data leads to poor predictions for any group).</p>
<p>The specific models considered in the paper are classified into the following:</p>
<ol type="1">
<li><p>Model G: A single common smoother for all observations i.e a global smoother.</p></li>
<li><p>Model GS: A global smoother plus group-level smoothers that have the same wiggliness.</p></li>
<li><p>Model GI: A global smoother plus group-level smoothers with differing wiggliness.</p></li>
<li><p>Model S: Group-specific smoothers having same wiggliness. This model does not contain a global smoother.</p></li>
<li><p>Model I: Group-specific smoothers with different wiggliness. This model does not contain a global smoother.</p></li>
</ol>
<section id="dataset-1-datasetsco2" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="dataset-1-datasetsco2">Dataset 1: <code>datasets::CO2</code></h2>
<p>An experiment on the cold tolerance of a particular grass species, was conducted to measure carbon dioxide (<span class="math inline">\(CO_2\)</span>) absorption in plants from two different regions. Twelve plants were used in the study: six sourced from Quebec and six from Mississippi. The researchers assessed the plants’ <span class="math inline">\(CO_2\)</span> uptake at various concentrations of atmospheric carbon dioxide. As part of the experimental design, half of the plant specimens were subjected to overnight chilling prior to data collection. This resulted in a total of 84 observations.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 9%">
<col style="width: 90%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Descriptions</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Plant</td>
<td style="text-align: left;">an ordered factor with levels Qn1 &lt; Qn2 &lt; Qn3 &lt; … &lt; Mc1 giving a unique identifier for each plant.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Type</td>
<td style="text-align: left;">a factor with levels Quebec Mississippi giving the origin of the plant</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Treatment</td>
<td style="text-align: left;">a factor with levels nonchilled chilled</td>
</tr>
<tr class="even">
<td style="text-align: left;">conc</td>
<td style="text-align: left;">a numeric vector of ambient carbon dioxide concentrations (mL/L).</td>
</tr>
<tr class="odd">
<td style="text-align: left;">uptake</td>
<td style="text-align: left;">a numeric vector of carbon dioxide uptake rates</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>For the HGAM paper, a slight modification was done to include a variable <em>Plant_uo</em>, which is an unordered factor variable, and is a replication of the <em>Plant</em> variable included in the dataset. The response variable is the log of <code>Uptake</code>.</p>
<section id="model-g-global-smoother" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="model-g-global-smoother">Model G: Global smoother</h3>
<div class="page-columns page-full"><p>In this first model, we include a random intercept for the plant identifiers, and use the RW2 smoother for log concentration.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></p><div class="no-row-height column-margin column-container"><li id="fn7"><p><sup>7</sup>&nbsp;In the paper, log-uptake is modelled using two smoothers: a TPRS(<code>smooth.construct.tp.smooth.spec {mgcv}</code>) of log-concentration (conc), and a random effect smooth(<code>smooth.construct.re.smooth.spec {mgcv}</code>) for the plant identifier (plant_uo).</p></li></div></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mgcv model</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>g_mgcv <span class="ot">&lt;-</span> <span class="fu">gam</span>(log_uptake <span class="sc">~</span> <span class="fu">s</span>(log_conc, <span class="at">k=</span><span class="dv">5</span>, <span class="at">bs=</span><span class="st">"tp"</span>) <span class="sc">+</span> <span class="fu">s</span>(plant_uo, <span class="at">k=</span><span class="dv">12</span>, <span class="at">bs=</span><span class="st">"re"</span>),</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>d1, <span class="at">method=</span><span class="st">"REML"</span>, <span class="at">family=</span><span class="st">"gaussian"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># inla model</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>g_inla <span class="ot">&lt;-</span> <span class="fu">inla</span>(log_uptake <span class="sc">~</span> <span class="fu">f</span>(log_conc, <span class="at">model =</span> <span class="st">"rw2"</span>) <span class="sc">+</span> <span class="fu">f</span>(plant_uo, <span class="at">model =</span> <span class="st">"iid"</span>),</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">family =</span> <span class="st">"gaussian"</span>, <span class="at">data =</span> d1,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">dic =</span> T, <span class="at">waic =</span> T))</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>d1 <span class="sc">|&gt;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">mgcv =</span> <span class="fu">predict</span>(g_mgcv, <span class="at">type =</span> <span class="st">'response'</span>) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>() <span class="sc">|&gt;</span> <span class="fu">exp</span>(),</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">inla =</span> g_inla<span class="sc">$</span>summary.fitted.values<span class="sc">$</span>mean <span class="sc">|&gt;</span> <span class="fu">exp</span>()</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> conc, <span class="at">y =</span> uptake)) <span class="sc">+</span> </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> conc, <span class="at">y =</span> mgcv), <span class="at">col =</span> <span class="st">'red'</span>, <span class="at">lty =</span> <span class="st">'dashed'</span>) <span class="sc">+</span> </span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> conc, <span class="at">y =</span> inla), <span class="at">col =</span> <span class="st">'black'</span>) <span class="sc">+</span> </span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> plant_uo, <span class="at">scales =</span> <span class="st">'free_y'</span>) <span class="sc">+</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model G: Global Smoothers"</span>,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(<span class="st">'CO'</span>[<span class="dv">2</span>]<span class="sc">~</span><span class="st">''</span><span class="sc">~</span><span class="st">'Concentration (mL L'</span><span class="sc">^-</span><span class="dv">1</span><span class="sc">*</span><span class="st">')'</span>),</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">expression</span>(<span class="st">'CO'</span>[<span class="dv">2</span>]<span class="sc">~</span><span class="st">'Uptake (µmol m'</span><span class="sc">^-</span><span class="dv">2</span><span class="sc">~</span><span class="st">')'</span>),</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">caption =</span> <span class="st">"The black fitted line is the INLA model, whereas, the red dashed line is the MGCV GAM model"</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  my_theme</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/g-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>From the fitted model, the global smoothing is adequate, although it under estimates the log-uptake in some plant species such as Qn2, and over estimates the log-uptake in plant species such as Mc2 and Mc3. It is clear that the RW2 and the TPRS model have similar predictions.</p>
</section>
<section id="model-gs-a-global-smoother-and-group-level-smoothers-with-same-wiggliness" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="model-gs-a-global-smoother-and-group-level-smoothers-with-same-wiggliness">Model GS: A global smoother and group-level smoothers with same wiggliness</h3>
<p>This second model resembles a mixed effect model with varying slopes. In the model - on top of the global smoother, each group is allowed to have its own smoother for a given variable, however the smoothers are estimated using one parameter for all groups (yielding the same wiggliness), and are penalized towards zero. The mgcv implementation of this is in the smooth function <code>fs</code> for factor-smoother interaction. This leads to a differing shape in the functional response of each group, as shown below.</p>
<div class="page-columns page-full"><p>The <code>R-INLA</code> implementation, will rely on using the `replicate`` function<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>.</p><div class="no-row-height column-margin column-container"><li id="fn8"><p><sup>8</sup>&nbsp;Note that in mgcv, we do not include the random intercepts smooth, as they are included in the factor-smooth interactions.</p></li></div></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mgcv model</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>gs_mgcv <span class="ot">&lt;-</span> <span class="fu">gam</span>(log_uptake <span class="sc">~</span> </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">s</span>(log_conc, <span class="at">k =</span> <span class="dv">5</span>, <span class="at">m =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">s</span>(log_conc, plant_uo, <span class="at">k =</span> <span class="dv">5</span>, <span class="at">bs =</span> <span class="st">"fs"</span>, <span class="at">m =</span> <span class="dv">2</span>),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>d1, <span class="at">method=</span><span class="st">"REML"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># inla model</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>gs_inla <span class="ot">&lt;-</span> <span class="fu">inla</span>(log_uptake <span class="sc">~</span> </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">f</span>(plant_uo, <span class="at">model=</span><span class="st">"iid"</span>) <span class="sc">+</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">f</span>(log_conc_global, <span class="at">model =</span> <span class="st">'rw2'</span>) <span class="sc">+</span> </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">f</span>(log_conc, <span class="at">model =</span> <span class="st">"rw2"</span>, <span class="at">replicate =</span> plant_uo_id),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> d1 <span class="sc">|&gt;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(<span class="at">plant_uo_id =</span> <span class="fu">as.integer</span>(plant_uo),</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                         <span class="at">log_conc_global =</span> log_conc),</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">dic =</span> T, <span class="at">waic =</span> T))</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>d1 <span class="sc">|&gt;</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">mgcv =</span> <span class="fu">predict</span>(gs_mgcv, <span class="at">type =</span> <span class="st">'response'</span>) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>() <span class="sc">|&gt;</span> <span class="fu">exp</span>(),</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">inla =</span> gs_inla<span class="sc">$</span>summary.fitted.values<span class="sc">$</span>mean <span class="sc">|&gt;</span> <span class="fu">exp</span>(),</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> conc, <span class="at">y =</span> uptake)) <span class="sc">+</span> </span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> conc, <span class="at">y =</span> mgcv), <span class="at">col =</span> <span class="st">'red'</span>, <span class="at">lty=</span><span class="st">'dashed'</span>) <span class="sc">+</span> </span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> conc, <span class="at">y =</span> inla), <span class="at">col =</span> <span class="st">'black'</span>) <span class="sc">+</span> </span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>plant_uo, <span class="at">scales =</span> <span class="st">'free_y'</span>) <span class="sc">+</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model GS: Global Smoothers + group smoothers with same wiggliness"</span>,</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"The black fitted line is the INLA model, whereas, the red dashed line is the MGCV GAM model"</span>,</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(<span class="st">'CO'</span>[<span class="dv">2</span>]<span class="sc">~</span><span class="st">''</span><span class="sc">~</span><span class="st">'Concentration (mL L'</span><span class="sc">^-</span><span class="dv">1</span><span class="sc">*</span><span class="st">')'</span>),</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">expression</span>(<span class="st">'CO'</span>[<span class="dv">2</span>]<span class="sc">~</span><span class="st">'Uptake (µmol m'</span><span class="sc">^-</span><span class="dv">2</span><span class="sc">~</span><span class="st">')'</span>))<span class="sc">+</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  my_theme</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/gs-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>The above fitted lines show an improvement over the model G, and the INLA and mgcv predictions are also close.</p>
</section>
<section id="model-gi-a-global-smoother-plus-group-level-smoothers-with-differing-wiggliness" class="level3">
<h3 class="anchored" data-anchor-id="model-gi-a-global-smoother-plus-group-level-smoothers-with-differing-wiggliness">Model GI: A global smoother plus group-level smoothers with differing wiggliness</h3>
<p>This is an extension of the G model above, where each group smoother is allowed to have its own parameters, which yields a model where the smoothers have differing wiggliness. This is an important extension if there is reason to believe that each group smooth differs in how wiggly it is.</p>
<p>This is achieved in INLA using the <code>group</code> argument when specifying functions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mgcv model</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>gi_mgcv <span class="ot">&lt;-</span> <span class="fu">gam</span>(log_uptake <span class="sc">~</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">s</span>(plant_uo, <span class="at">bs =</span> <span class="st">'re'</span>, <span class="at">k =</span> <span class="dv">12</span>) <span class="sc">+</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">s</span>(log_conc, <span class="at">k =</span> <span class="dv">5</span>, <span class="at">m =</span> <span class="dv">2</span>, <span class="at">bs =</span> <span class="st">'tp'</span>) <span class="sc">+</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">s</span>(log_conc, <span class="at">k =</span> <span class="dv">5</span>, <span class="at">m =</span> <span class="dv">1</span>, <span class="at">bs =</span> <span class="st">"tp"</span>, <span class="at">by =</span> plant_uo),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">data=</span>d1, <span class="at">method=</span><span class="st">"REML"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># inla model</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>gi_inla <span class="ot">&lt;-</span> <span class="fu">inla</span>(log_uptake <span class="sc">~</span> </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">f</span>(plant_uo, <span class="at">model=</span><span class="st">"iid"</span>) <span class="sc">+</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">f</span>(log_conc_global, <span class="at">model =</span> <span class="st">"rw2"</span>) <span class="sc">+</span> </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">f</span>(log_conc, <span class="at">model =</span> <span class="st">"rw2"</span>, <span class="at">group =</span> plant_uo_id),</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> d1 <span class="sc">|&gt;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(<span class="at">plant_uo_id =</span> <span class="fu">as.integer</span>(plant_uo),</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>                         <span class="at">log_conc_global =</span> log_conc),</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>                <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">dic =</span> T, <span class="at">waic =</span> T))</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>d1 <span class="sc">|&gt;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">mgcv =</span> <span class="fu">predict</span>(gi_mgcv, <span class="at">type =</span> <span class="st">'response'</span>) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>() <span class="sc">|&gt;</span> <span class="fu">exp</span>(),</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">inla =</span> gi_inla<span class="sc">$</span>summary.fitted.values<span class="sc">$</span>mean <span class="sc">|&gt;</span> <span class="fu">exp</span>(),</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> conc, <span class="at">y =</span> uptake)) <span class="sc">+</span> </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> conc, <span class="at">y =</span> mgcv), <span class="at">col =</span> <span class="st">'red'</span>, <span class="at">lty=</span><span class="st">'dashed'</span>) <span class="sc">+</span> </span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> conc, <span class="at">y =</span> inla), <span class="at">col =</span> <span class="st">'black'</span>) <span class="sc">+</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>plant_uo, <span class="at">scales =</span> <span class="st">'free_y'</span>) <span class="sc">+</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model GI: Global Smoothers + group smoothers with differing wiggliness"</span>,</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"The black fitted line is the INLA model, whereas, the red dashed line is the MGCV GAM model"</span>,</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(<span class="st">'CO'</span>[<span class="dv">2</span>]<span class="sc">~</span><span class="st">''</span><span class="sc">~</span><span class="st">'Concentration (mL L'</span><span class="sc">^-</span><span class="dv">1</span><span class="sc">*</span><span class="st">')'</span>),</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">expression</span>(<span class="st">'CO'</span>[<span class="dv">2</span>]<span class="sc">~</span><span class="st">'Uptake (µmol m'</span><span class="sc">^-</span><span class="dv">2</span><span class="sc">~</span><span class="st">')'</span>))<span class="sc">+</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  my_theme</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/gi-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>There isn’t much difference as compared to the GS model above, however, the GI model and mgcv HGAM model have close predictions. The GI model is an improvement over the model G.</p>
</section>
<section id="models-without-global-smoothers-model-s-and-i" class="level3">
<h3 class="anchored" data-anchor-id="models-without-global-smoothers-model-s-and-i">Models without global smoothers (Model S and I)</h3>
<p>In this section, we focus on implementing hierarchical generalized additive models (HGAMs) without global smooths. By omitting the global smoother, we remove the constraint that penalizes deviations of group-level smooths from a common smooth This is particularly important when we believe that the group-level smooths may not align with or may differ significantly from a common global pattern.</p>
<p>Model S is an instance of model GS above, without the global smooth, and model I is an instance of model GI above, without the global smooth.</p>
<p>A drawdown of using models without global smooths (model S and I) is that, in instances where the number of data points is small in each group, then the results from the models S &amp; I will be more variable than those from model GS and GI. This increased variability stems from the fact that group-specific smooths in models S &amp; I rely solely on within-group data, without the stabilizing influence of a global smooth or leveraged information across all groups.</p>
<p>Another drawdown is: without global smooths, it is not possible to predict the response variables for groups not included in the training set, and it is also not possible to compute an average effect of the response variable.</p>
<section id="model-s" class="level4">
<h4 class="anchored" data-anchor-id="model-s">Model S</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mgcv model</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>s_mgcv <span class="ot">&lt;-</span> <span class="fu">gam</span>(log_uptake <span class="sc">~</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">s</span>(log_conc, plant_uo, <span class="at">k =</span> <span class="dv">5</span>, <span class="at">bs =</span> <span class="st">"fs"</span>, <span class="at">m =</span> <span class="dv">2</span>),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>d1, <span class="at">method=</span><span class="st">"REML"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># inla model</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>s_inla <span class="ot">&lt;-</span> <span class="fu">inla</span>(log_uptake <span class="sc">~</span> </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">f</span>(plant_uo, <span class="at">model=</span><span class="st">"iid"</span>) <span class="sc">+</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">f</span>(log_conc, <span class="at">model =</span> <span class="st">"rw2"</span>, <span class="at">replicate =</span> plant_uo_id),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> d1 <span class="sc">|&gt;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(<span class="at">plant_uo_id =</span> <span class="fu">as.integer</span>(plant_uo)),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">dic =</span> T, <span class="at">waic =</span> T))</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>d1 <span class="sc">|&gt;</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">mgcv =</span> <span class="fu">predict</span>(s_mgcv, <span class="at">type =</span> <span class="st">'response'</span>) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>() <span class="sc">|&gt;</span> <span class="fu">exp</span>(),</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">inla =</span> s_inla<span class="sc">$</span>summary.fitted.values<span class="sc">$</span>mean <span class="sc">|&gt;</span> <span class="fu">exp</span>(),</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> conc, <span class="at">y =</span> uptake)) <span class="sc">+</span> </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> conc, <span class="at">y =</span> mgcv), <span class="at">col =</span> <span class="st">'red'</span>, <span class="at">lty=</span><span class="st">'dashed'</span>) <span class="sc">+</span> </span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> conc, <span class="at">y =</span> inla), <span class="at">col =</span> <span class="st">'black'</span>) <span class="sc">+</span> </span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>plant_uo, <span class="at">scales =</span> <span class="st">'free_y'</span>) <span class="sc">+</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model S: Group smoothers with same wiggliness"</span>,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"The black fitted line is the INLA model, whereas, the red dashed line is the MGCV GAM model"</span>,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(<span class="st">'CO'</span>[<span class="dv">2</span>]<span class="sc">~</span><span class="st">''</span><span class="sc">~</span><span class="st">'Concentration (mL L'</span><span class="sc">^-</span><span class="dv">1</span><span class="sc">*</span><span class="st">')'</span>),</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">expression</span>(<span class="st">'CO'</span>[<span class="dv">2</span>]<span class="sc">~</span><span class="st">'Uptake (µmol m'</span><span class="sc">^-</span><span class="dv">2</span><span class="sc">~</span><span class="st">')'</span>))<span class="sc">+</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  my_theme</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/s-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>The predictions from the INLA model, are quite close to the actual values for the response variable.</p>
</section>
<section id="model-i" class="level4">
<h4 class="anchored" data-anchor-id="model-i">Model I</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mgcv model</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>i_mgcv <span class="ot">&lt;-</span> <span class="fu">gam</span>(log_uptake <span class="sc">~</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">s</span>(plant_uo, <span class="at">bs =</span> <span class="st">'re'</span>, <span class="at">k =</span> <span class="dv">12</span>) <span class="sc">+</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">s</span>(log_conc, <span class="at">k =</span> <span class="dv">5</span>, <span class="at">m =</span> <span class="dv">1</span>, <span class="at">bs =</span> <span class="st">"tp"</span>, <span class="at">by =</span> plant_uo),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">data=</span>d1, <span class="at">method=</span><span class="st">"REML"</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># inla model</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>i_inla <span class="ot">&lt;-</span> <span class="fu">inla</span>(log_uptake <span class="sc">~</span> </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">f</span>(plant_uo, <span class="at">model=</span><span class="st">"iid"</span>) <span class="sc">+</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">f</span>(log_conc, <span class="at">model =</span> <span class="st">"rw2"</span>, <span class="at">group =</span> plant_uo_id),</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> d1 <span class="sc">|&gt;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(<span class="at">plant_uo_id =</span> <span class="fu">as.integer</span>(plant_uo)),</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">dic =</span> T, <span class="at">waic =</span> T))</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>d1 <span class="sc">|&gt;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">mgcv =</span> <span class="fu">predict</span>(i_mgcv, <span class="at">type =</span> <span class="st">'response'</span>) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>() <span class="sc">|&gt;</span> <span class="fu">exp</span>(),</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">inla =</span> i_inla<span class="sc">$</span>summary.fitted.values<span class="sc">$</span>mean <span class="sc">|&gt;</span> <span class="fu">exp</span>(),</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> conc, <span class="at">y =</span> uptake)) <span class="sc">+</span> </span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> conc, <span class="at">y =</span> mgcv), <span class="at">col =</span> <span class="st">'red'</span>, <span class="at">lty=</span><span class="st">'dashed'</span>) <span class="sc">+</span> </span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> conc, <span class="at">y =</span> inla), <span class="at">col =</span> <span class="st">'black'</span>) <span class="sc">+</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>plant_uo, <span class="at">scales =</span> <span class="st">'free_y'</span>) <span class="sc">+</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model I: Group smoothers with differing wiggliness"</span>,</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"The black fitted line is the INLA model, whereas, the red dashed line is the MGCV GAM model"</span>,</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(<span class="st">'CO'</span>[<span class="dv">2</span>]<span class="sc">~</span><span class="st">''</span><span class="sc">~</span><span class="st">'Concentration (mL L'</span><span class="sc">^-</span><span class="dv">1</span><span class="sc">*</span><span class="st">')'</span>),</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">expression</span>(<span class="st">'CO'</span>[<span class="dv">2</span>]<span class="sc">~</span><span class="st">'Uptake (µmol m'</span><span class="sc">^-</span><span class="dv">2</span><span class="sc">~</span><span class="st">')'</span>))<span class="sc">+</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  my_theme</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/i-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>The predictions from the INLA model are closer to those of the MGCV HGAMs for certain groups.</p>
</section>
</section>
</section>
</section>
<section id="comparisons" class="level1 page-columns page-full">
<h1>Comparisons</h1>
<p>In this section, we compare the fitted models (G, S, I, GS, GI) using the Deviance Information Criterion, as shown below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Model G"</span>, <span class="st">"Model S"</span>, <span class="st">"Model I"</span>, <span class="st">"Model GS"</span>, <span class="st">"Model GI"</span>),</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">DIC =</span> <span class="fu">list</span>(g_inla, s_inla, i_inla, gs_inla, gi_inla) <span class="sc">|&gt;</span> <span class="fu">lapply</span>(<span class="at">FUN =</span> \(x) x<span class="sc">$</span>dic<span class="sc">$</span>dic) <span class="sc">|&gt;</span> <span class="fu">unlist</span>(),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="fu">list</span>(g_inla, s_inla, i_inla, gs_inla, gi_inla) <span class="sc">|&gt;</span> <span class="fu">lapply</span>(<span class="at">FUN =</span> \(x) x<span class="sc">$</span>waic<span class="sc">$</span>waic) <span class="sc">|&gt;</span> <span class="fu">unlist</span>()</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">model</th>
<th style="text-align: right;">DIC</th>
<th style="text-align: right;">WAIC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Model G</td>
<td style="text-align: right;">-116.1953</td>
<td style="text-align: right;">-111.2939</td>
</tr>
<tr class="even">
<td style="text-align: left;">Model S</td>
<td style="text-align: right;">-444.0115</td>
<td style="text-align: right;">-448.7367</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Model I</td>
<td style="text-align: right;">-215.8004</td>
<td style="text-align: right;">-214.5594</td>
</tr>
<tr class="even">
<td style="text-align: left;">Model GS</td>
<td style="text-align: right;">-210.8557</td>
<td style="text-align: right;">-209.1680</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Model GI</td>
<td style="text-align: right;">-209.9247</td>
<td style="text-align: right;">-208.6807</td>
</tr>
</tbody>
</table>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>In the HGAM paper, the models from best fitting to worst are: I &gt; S &gt; GI &gt; GS &gt; G, with model I and S being so close in AIC values.</p>
</div></div><p>From the table above, model S seems to be the best fitting model, as indicated by the lowest DIC &amp; WAIC values.</p>
<p>The order of fit, from best fitting to worst is: S &gt; I &gt; GS &gt; GI &gt; G. However, the performance of model GS and GI are so close.</p>
<p>This indicates that, for the CO2 dataset:</p>
<ol type="1">
<li><p>There is a compelling reason for including group level smoothing. This is because the model without group level smooths (model G) performs the worst as compared to the rest of the models.</p></li>
<li><p>There is no need for independent group specific smooths (model GI), as the performance gain from using common/shared group smooths (model GS) is minimal.</p></li>
<li><p>There is no need for a global smooth, as model S &amp; I have better performance as compared to all models which included a global smooth</p></li>
<li><p>As model S has better performance than I, this implies that there is a common smooth structure in how uptake is affected by changes in concentration across all plant specimens, and that the additional complexity of plant-specific smooth terms is not justified by the data.</p></li>
</ol>
</section>
<section id="references" class="level1">
<h1>References</h1>
<p>Books</p>
<ul>
<li><p>Gómez-Rubio, V. (2020). <em>Bayesian inference with INLA</em>. Chapman and Hall/CRC.</p></li>
<li><p>Wang, X., Yue, Y. R., &amp; Faraway, J. J. (2018). <em>Bayesian regression modeling with INLA</em>. Chapman and Hall/CRC.</p></li>
<li><p>Wickham, H. (2016). <em>ggplot2: Elegant Graphics for Data Analysis</em>. Springer-Verlag New York.</p></li>
<li><p>Wood, S. N. (2017). <em>Generalized Additive Models: An Introduction with R</em> (2nd ed.). Chapman and Hall/CRC.</p></li>
</ul>
<p>Articles</p>
<ul>
<li><p>Pedersen, E. J., Miller, D. L., Simpson, G. L., &amp; Ross, N. (2019). Hierarchical generalized additive models in ecology: An introduction with mgcv. <em>PeerJ</em>, 7, e6876.</p></li>
<li><p>Rue, H., Martino, S., &amp; Chopin, N. (2009). Approximate Bayesian inference for latent Gaussian models using integrated nested Laplace approximations (with discussion). <em>Journal of the Royal Statistical Society: Series B (Statistical Methodology)</em>, 71(2), 319–392.</p></li>
<li><p>Wood, S. N. (2003). Thin-plate regression splines. <em>Journal of the Royal Statistical Society: Series B (Statistical Methodology)</em>, 65(1), 95–114.</p></li>
</ul>
<p>Software</p>
<ul>
<li>R Core Team (2023). <em>R: A Language and Environment for Statistical Computing</em>. R Foundation for Statistical Computing, Vienna, Austria. Retrieved from <a href="https://www.R-project.org/" class="uri">https://www.R-project.org/</a></li>
</ul>
<hr>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.2 (2023-10-31)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.6.6

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Africa/Nairobi
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] mgcv_1.9-1    nlme_3.1-164  INLA_24.02.09 sp_2.1-3      Matrix_1.6-5 
[6] ggplot2_3.5.1 dplyr_1.1.4   pacman_0.5.1 

loaded via a namespace (and not attached):
 [1] utf8_1.2.4         generics_0.1.3     class_7.3-22       fmesher_0.1.5     
 [5] KernSmooth_2.23-22 lattice_0.22-6     digest_0.6.35      magrittr_2.0.3    
 [9] evaluate_0.24.0    grid_4.3.2         fastmap_1.2.0      jsonlite_1.8.8    
[13] e1071_1.7-14       DBI_1.2.2          fansi_1.0.6        scales_1.3.0      
[17] cli_3.6.2          rlang_1.1.4        units_0.8-5        munsell_0.5.1     
[21] splines_4.3.2      withr_3.0.0        yaml_2.3.8         tools_4.3.2       
[25] parallel_4.3.2     MatrixModels_0.5-3 colorspace_2.1-0   vctrs_0.6.5       
[29] R6_2.5.1           proxy_0.4-27       lifecycle_1.0.4    classInt_0.4-10   
[33] htmlwidgets_1.6.4  pkgconfig_2.0.3    pillar_1.9.0       gtable_0.3.5      
[37] glue_1.7.0         Rcpp_1.0.13        sf_1.0-16          xfun_0.45         
[41] tibble_3.2.1       tidyselect_1.2.1   rstudioapi_0.16.0  knitr_1.47        
[45] farver_2.1.2       htmltools_0.5.8.1  rmarkdown_2.27     labeling_0.4.3    
[49] compiler_4.3.2    </code></pre>
</div>
</div>


</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>